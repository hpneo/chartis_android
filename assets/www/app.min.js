$.support.cors=true;$.ajaxSetup({timeout:2e4});var isiOS=false;var agent=navigator.userAgent.toLowerCase();if(agent.indexOf("iphone")>-1||agent.indexOf("ipod")>-1||agent.indexOf("ipad")>-1){isiOS=true}var clickEvent=$.support.touch?"touchstart":"click";$.exists=function(a){return $(a).length>0};$.fn.excerpt=function(a){var b=$(this);var c=b.text();while(b.width()>a){c=c.substr(0,c.length-4)+"...";b.text(c)}return c};if($.browser.mozilla){if(!window.console)console={};$.log=console.log||function(){};$.warn=console.warn||function(){};$.error=console.error||function(){};$.info=console.info||function(){}}else{$.log=function(){};$.warn=function(){};$.error=function(){};$.info=function(){}}var app=app||function(a,b){function n(){c.setLocation({success:function(){c.map=c.map||new GMaps({div:"#map",lat:c.location.lat,lng:c.location.lng,zoom:14,disableDefaultUI:true,click:function(a){c.markerSelected=null;if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}}});c.currentMap=c.map;c.setPlaces({success:function(){c.addPlacesInMap(c.places)}})}})}function m(b){a.info("[Find the nearest local]");var d="http://maps.googleapis.com/maps/api/distancematrix/json?language=es&sensor=false";var e={origins:c.location.lat+","+c.location.lng,destinations:[],mode:"driving"};var f=[];for(index in c.places){f.push(c.places[index].lat+","+c.places[index].lng);if(f.length>50)break}e.destinations=f.join("|");for(key in e)d+="&"+key+"="+e[key];var g="http://labs.renzocastro.com/proxy.php?callback=?&url=";d=g+escape(d);a.getJSON(d).success(function(d){a.info("[findTheNearestLocal] success");switch(d.status){case"OK":var e=-1,f=999999999999,g=d.rows[0].elements,h=g.length;for(i=0;i<h;++i){element=g[i];if(element.status=="OK"&&element.distance.value<f){f=element.distance.value;e=i}}c.placeNearest=c.places[e];if(b&&b.success){b.success.apply(window,b.successParams||[])}break;case"OVER_QUERY_LIMIT":a.warn("success:\n",d);c.placeNearest=c.places[2];if(b&&b.success){b.success.apply(window,b.successParams||[])}break;default:a.error("success:\n",d);break}}).error(function(b){a.error("[findTheNearestLocal] error\n",b);if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}})}function l(b){var e=a(b.target);var f=e.attr("id");switch(f){case"page-services":e.find(".dialog-loader").hide();break;case"page-list":c.loadStations();break;case"page-promo":c.loadPromos(c.promoFilter);break;case"page-promo-details":e.find(".dialog-loader").hide();e.find(".bannerContainer").width(c.getWidth());a("#page-promo-details .message p").html(c.offerSelected.name);a("#page-promo-details .bannerContainer img").attr("src",c.offerSelected["banner_"+(c.retina?"hd":"normal")]);a("#page-promo-details .btn-twitter").click(function(a){a.preventDefault();d("http://www.google.com")});break;case"page-checkin":var g=a('div:jqmData(role="header"):visible');var h=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-g.outerHeight()-h.outerHeight();a('div:jqmData(role="content"):visible').height(c.contentHeight);break}}function k(b){var d=a(b.target);var e=d.attr("id");var f="";switch(e){case"page-services":case"page-info":case"page-result":case"page-route":f="page-main";break;case"page-station-details":case"page-foursquare":case"page-checkin":f="page-list";break;case"page-promo-details":f="page-promo";break;default:f=e}a("div:jqmData(role='footer'):visible a[href='#"+f+"']").addClass("ui-btn-active");a.log(e,d.find('[data-iscroll="scroller"]'));if(d.find('[data-iscroll="scroller"]').length){a.log("iscroll");c.setScroll(d)}else{a.log("no scroll")}a('div:jqmData(role="header"):visible').css({"z-index":1e3});a('div:jqmData(role="footer"):visible').css({"z-index":1e3});switch(e){case"page-station-promos":if(c.stationSelected.offers.length){c.offerSelected=null;d.find("h1").html(c.stationSelected.name);var g='<ul data-role="listview">';a.each(c.stationSelected.offers,function(){g+='<li><a href="#page-promo-details"><h3>'+this.name+"</h3><p>"+this.description+"</p></a></li>"});g+="</ul>";d.find('div:jqmData(role="content")').html(g).find("ul:first").listview();d.find('a[href="#page-promo-details"]').each(function(b){a(this).click(function(a){c.offerSelected=c.stationSelected.offers[b]})})}else{d.find('div:jqmData(role="content")').html("Por el momento este local no cuenta con promociones.")}a.mobile.fixedToolbars.show(true);break;case"page-promo-stations":d.find('div:jqmData(role="content")').html("Cargando...");a.mobile.fixedToolbars.show(true);a.log("offer_id:"+c.offerSelected.id);a.getJSON("http://chartis.herokuapp.com/places.json?callback=?&offer_id="+c.offerSelected.id).success(function(b){c.stationsPromo=b;a.log(c.stationsPromo);if(c.stationsPromo.length==0){d.find('div:jqmData(role="content")').html("No se encontraron datos.");a.mobile.fixedToolbars.show(true);return}var e='<ul data-role="listview">';a.each(c.stationsPromo,function(a){e+='<li><a href="#page-station-details" data-place="'+a+'" ><h3>'+this.name+"</h3><p>"+this.address+"</p></a></li>"});e+="</ul>";d.find('div:jqmData(role="content")').html(e).find("ul:first").listview();a.mobile.fixedToolbars.show(true);d.find('a[href="#page-station-details"]').each(function(b){a(this).click(function(b){var d=a(this).attr("data-place");c.stationSelected=c.stationsPromo[d]})})}).error(function(b){a.error(b);if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}});break;case"page-info":a('div:jqmData(role="content"):visible ul:first').listview({create:function(){c.setScroll(d);setTimeout(function(){a.iScroll.refresh()},0);a.mobile.fixedToolbars.show(true)}});break;case"page-list":var h=a('div:jqmData(role="header"):visible');var i=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-h.outerHeight()-i.outerHeight();a('div:jqmData(role="content"):visible .content-inner').height(c.contentHeight);a(".ui-page:visible .ui-radio label").each(function(b){if(a(this).hasClass("ui-radio-on")){a('.ui-page:visible input[type="radio"]:eq('+b+")").attr("checked",true).checkboxradio("refresh")}});if(a('.ui-page:visible input[type="radio"]:checked').length==0){a('.ui-page:visible input[type="radio"]:first').attr("checked",true).checkboxradio("refresh")}break;case"page-station-details":var h=a('div:jqmData(role="header"):visible');var i=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-h.outerHeight()-i.outerHeight();a('div:jqmData(role="content"):visible .content-inner').height(c.contentHeight);d.find(".message p").html(c.stationSelected.address);d.find(".aviso .name").html(c.stationSelected.name);d.find(".subtitle .name").html(c.stationSelected.name);d.find("h1").html(c.stationSelected.name);d.find(".services").html("");c.mapStation=c.mapStation||new GMaps({div:"#map-station",lat:c.stationSelected.lat,lng:c.stationSelected.lng,zoom:15,disableDefaultUI:true,click:function(a){if(a.preventDefault)a.preventDefault();if(a.stopPropagation)a.stopPropagation()}});c.mapStation.fixResize();c.mapStation.setCenter(c.stationSelected.lat,c.stationSelected.lng);c.mapStation.removeMarkers();var j=c.mapStation.addMarker({lat:c.stationSelected.lat,lng:c.stationSelected.lng,title:c.stationSelected.name,address:c.stationSelected.address,station:c.stationSelected,click:function(a){if(a.preventDefault)a.preventDefault()}});c.stationSelected.marker=j;j.icon=new google.maps.MarkerImage("images/map/pin-red"+(c.retina?"@2":"")+".png",new google.maps.Size(32,32),new google.maps.Point(0,0),new google.maps.Point(16,32),c.retina?new google.maps.Size(32,32):null);j.shadow=new google.maps.MarkerImage("images/map/pin-shadow"+(c.retina?"@2":"")+".png",new google.maps.Size(52,32),new google.maps.Point(0,0),new google.maps.Point(16,32),c.retina?new google.maps.Size(50,32):null);j.shape={coord:[13,0,10,2,8,5,8,8,8,11,10,14,11,17,12,20,13,23,14,26,15,29,18,29,19,26,20,23,21,20,22,17,23,14,25,11,25,8,25,5,23,2,20,0],type:"poly"};if(c.stationSelected.services.length>0){var k='<ul data-role="listview">';a.each(c.stationSelected.services,function(a){k+="<li>";k+='<img src="images/empty.png" width="62" height="63" data-place="'+this.id+'" class="icon-service-'+c.servicesIcon[this.id]+'"/>';k+='<div class="li-inner">';k+="<h3>"+this.name+"</h3>";k+="<p>"+(this.description||"")+"</p>";k+="</div>";k+="</li>"});k+="</ul>";d.find(".services").html(k).find("ul:first").listview({create:function(){setTimeout(function(){a.iScroll.refresh()},0)}})}break}}function j(b){var d=a(b.target);a(".ui-page").css("minHeight",c.getHeight());switch(d.attr("id")){case"page-list":d.find('input[type="radio"]').bind("change",function(b){b.preventDefault();c.loadStations(a(this).val())});break;case"page-promo-details":a("#btn-share").bind(clickEvent,function(b){b.preventDefault();a(".ui-page:visible .dialog-loader").show()});break;case"page-station-details":break;case"page-route":var e="";a.each(c.places,function(a){e+='<option value="'+a+'">'+this.name+"</option>"});a("#edit-route .box .form .ui-select").each(function(){a(this).find("select").append(e)});c.routeTravelMode="driving";d.find('input[type="radio"]').bind("change",function(b){b.preventDefault();c.routeTravelMode=a(this).val()});break}}function h(d){var e=a('div:jqmData(role="header"):visible');var f=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-e.outerHeight();a("#map-route").width(c.getWidth());a("#map-route").height(c.contentHeight);a("#map-route").parent().height(c.contentHeight-f.outerHeight());a("#edit-route").height(c.getHeight());a(".ui-page:visible .ui-radio label").each(function(b){if(a(this).hasClass("ui-radio-on")){a('.ui-page:visible input[type="radio"]:eq('+b+")").attr("checked",true).checkboxradio("refresh")}});if(a('.ui-page:visible input[type="radio"]:checked').length==0){a('.ui-page:visible input[type="radio"]:first').attr("checked",true).checkboxradio("refresh")}if(c.markerSelected==b)return;c.stationSelected=c.markerSelected.station;a.mobile.showPageLoadingMsg();a("#page-route .message p").html("");a("#page-route h1:eq(1)").text("");c.setLocation({success:function(){c.mapRoute=c.mapRoute||new GMaps({div:"#map-route",lat:c.location.lat,lng:c.location.lng,zoom:14,disableDefaultUI:true,click:function(a){c.markerSelected=null;if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}}});c.currentMap=c.mapRoute;c.currentMap.fixResize();c.setRoute(c.stationSelected,c.location,c.resultTravelMode)}})}function g(b){a("#page-route").live("pageshow",h);a("#page-route #btnChange").bind(clickEvent,function(b){var c=a("#edit-route .box .form1").css("display")=="block";a("#edit-route .box .form1").css({display:c?"none":"block"});a("#edit-route .box .form2").css({display:!c?"none":"block"});a("#page-route select:eq("+(c?"1":"0")+")")[0].selectedIndex=a("#page-route select:eq("+(!c?"1":"0")+")")[0].selectedIndex;a("#page-route select:eq("+(c?"1":"0")+")").selectmenu("refresh");a("#page-route .ui-input-text:eq("+(c?"1":"0")+")").val(a("#page-route .ui-input-text:eq("+(!c?"1":"0")+")").val())});a("#page-route #route-edit").bind(clickEvent,function(b){a("#page-route #edit-route").show()});a("#page-route #route-cancel").bind(clickEvent,function(b){a("#page-route #edit-route").hide()});a("#page-route #route-search").bind(clickEvent,function(b){var d=a("#edit-route .box .form1").css("display")=="block";var e=a("#page-route .route-start:visible").val();var f=a("#page-route .route-final:visible").val();var g=!d?e:f;c.stationSelected=c.places[g];c.geocode({address:d?e:f,callback:function(b,d){switch(d){case"OK":var e=b[0].geometry.location;c.routeLocation={lat:e.lat(),lng:e.lng(),title:"Ubicación Actual",address:""};c.geocode({lat:c.routeLocation.lat,lng:c.routeLocation.lng,callback:function(b,d){switch(d){case"OK":c.routeLocation.address=b.length?b[0].formatted_address:"";break;default:c.routeLocation.address="...";break}c.setRoute(c.stationSelected,c.routeLocation,c.routeTravelMode);a("#edit-route").hide()}});break;case"ZERO_RESULTS":default:alert("La dirección ingresada no pudo ser encontrada.");break}}})});a("#page-route .GPS a").bind(clickEvent,function(a){a.preventDefault();if(c.routeLocationMarker)c.currentMap.removeMarker(c.routeLocationMarker);c.setLocation({success:function(){c.routeLocationMarker=c.setMarkerCurrentPosition()}})});c.polygons=[];a("#page-route #route-left").css({cursor:"auto"});a("#page-route #route-left .ui-icon").css({opacity:.3});a("#page-route #route-left").click(function(b){b.preventDefault();if(c.step_index==0)return;c.step_index--;if(c.step_index==0){a("#page-route .message p").html("Inicia tu recorrido hacia el <strong>Primax</strong> de "+c.stationSelected.name);c.currentMap.setCenter(c.location.lat,c.location.lng)}else{a("#page-route .message p").html(c.step[c.step_index-1].instructions);c.currentMap.setCenter(c.step[c.step_index-1].end_point.lat(),c.step[c.step_index-1].end_point.lng())}a("#page-route h1:eq(1)").text(c.step_index+1+" de "+(c.step.length+1));c.polygons[c.step_index].setMap(null);a("#page-route #route-right").css({cursor:"pointer"});a("#page-route #route-right .ui-icon").css({opacity:1});if(c.step_index==0){a("#page-route #route-left").css({cursor:"auto"});a("#page-route #route-left .ui-icon").css({opacity:.3})}});a("#page-route #route-right").click(function(b){b.preventDefault();if(c.step_index>=c.step.length)return;c.polygons[c.step_index]=c.currentMap.drawPolyline({path:c.step[c.step_index].path,strokeColor:c.routeColor,strokeOpacity:.4,strokeWeight:6});a("#page-route h1:eq(1)").text(c.step_index+2+" de "+(c.step.length+1));c.currentMap.setCenter(c.step[c.step_index].end_point.lat(),c.step[c.step_index].end_point.lng());if(c.step_index==c.step.length-1){a("#page-route .message p").html("Llegaste al <strong>PRIMAX</strong> de "+c.stationSelected.name)}else{a("#page-route .message p").html(c.step[c.step_index].instructions)}c.step_index++;a("#page-route #route-left").css({cursor:"pointer"});a("#page-route #route-left .ui-icon").css({opacity:1});if(c.step_index==c.step.length){a("#page-route #route-right").css({cursor:"auto"});a("#page-route #route-right .ui-icon").css({opacity:.3})}})}function f(b){a(".ui-page:visible .ui-radio label").each(function(b){if(a(this).hasClass("ui-radio-on")){a('.ui-page:visible input[type="radio"]:eq('+b+")").attr("checked",true).checkboxradio("refresh")}});if(a('.ui-page:visible input[type="radio"]:checked').length==0){a('.ui-page:visible input[type="radio"]:first').attr("checked",true).checkboxradio("refresh")}}function e(b){a("#page-promo").live("pageshow",f);c.promoFilter="todos";a('#page-promo input[type="radio"]').bind("change",function(b){b.preventDefault();c.promoFilter=a(this).val();c.loadPromos(c.promoFilter)})}function d(a){window.plugins.childBrowser.showWebPage(a)}var c={};c.map=null;c.mapResult=null;c.mapRoute=null;c.currentMap=null;c.retina=window.devicePixelRatio>1;c.placesLoading=false;c.contentHeight=0;c.markerSelected=null;c.markerLocation=null;c.overlayItem=null;c.location=null;c.geocoder=new google.maps.Geocoder;c.placeNearest=null;c.routeColor="#ee5008";c.routeMarkers=[];c.ready=function(){a.info("[ready]");a(document).bind("touchmove",function(a){a.preventDefault()},false);a("body").bind("touchmove",function(a){a.preventDefault()},false);a(window).bind("resize",function(a){if(c.currentMap){c.currentMap.fixResize()}});a(document).bind("pagecreate",j);a(document).bind("pagebeforeshow",l);a(document).bind("pageshow",k);a("#page-main").live("pageinit",c.onInitMain);a("#page-services").live("pageinit",c.onInitServices);a("#page-info").live("pageinit",c.onInitInfo);a("#page-result").live("pageinit",c.onInitResult);a("#page-route").live("pageinit",g);a("#page-promo").live("pageinit",e);a(document).ready(function(){a.info("[document] ready")})};c.setRoute=function(b,d,e){c.currentMap.removeMarkers();c.currentMap.removeOverlays();c.currentMap.removePolylines();c.setMarkerCurrentPosition({location:d,pinType:"red"});c.stationSelected=b;var f=c.currentMap.addMarker({lat:b.lat,lng:b.lng,title:b.name,address:b.address,station:b,click:function(a){if(a.preventDefault)a.preventDefault();if(c.overlayItem)c.currentMap.removeOverlay(c.overlayItem);var b=a.marker.position.lat();var d=a.marker.position.lng();c.markerSelected=a.marker;c.currentMap.setCenter(b,d);c.setOverlayItem()}});f.icon=new google.maps.MarkerImage("images/map/pin-green2"+(c.retina?"@2x":"")+".png",new google.maps.Size(16,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(16,37):null);f.shadow=new google.maps.MarkerImage("images/map/pin-shadow"+(c.retina?"@2x":"")+".png",new google.maps.Size(38,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(38,37):null);f.shape={coord:[10,0,12,1,13,2,14,3,15,4,15,5,15,6,15,7,15,8,15,9,15,10,15,11,15,12,14,13,13,14,11,15,9,16,9,17,9,18,9,19,9,20,9,21,9,22,9,23,9,24,9,25,9,26,9,27,9,28,9,29,9,30,9,31,9,32,11,33,11,34,11,35,11,36,4,36,4,35,5,34,5,33,7,32,7,31,7,30,7,29,7,28,7,27,7,26,7,25,7,24,7,23,7,22,7,21,7,20,7,19,7,18,7,17,7,16,5,15,3,14,2,13,1,12,1,11,0,10,0,9,0,8,0,7,0,6,1,5,1,4,2,3,3,2,4,1,6,0,10,0],type:"poly"};c.currentMap.drawRoute({origin:[d.lat,d.lng],destination:[b.lat,b.lng],travelMode:e,strokeColor:c.routeColor,strokeOpacity:.3,strokeWeight:6});c.step=[];c.currentMap.getRoutes({travelMode:e,origin:[d.lat,d.lng],destination:[b.lat,b.lng],callback:function(d){if(d.length>0){route=d[d.length-1];if(route.legs.length>0)for(i in route.legs[0].steps){step=route.legs[0].steps[i];step["step_number"]=i;c.step.push(step)}c.step_index=0;c.step_length=c.step.length;a("#page-route .message p").html("Inicia tu recorrido hacia el <strong>Primax</strong> de "+b.name);a("#page-route h1:eq(1)").text("1 de "+(c.step.length+1));a.mobile.hidePageLoadingMsg()}c.route=new GMaps.Route({map:c.currentMap,route:d[0],strokeColor:c.routeColor,strokeOpacity:.7,strokeWeight:6})}})};c.setScroll=function(d){$wrapper=d.find('[data-iscroll="scroller"]');if($wrapper.length==0)return;var e=a('div:jqmData(role="header"):visible');var f=a('div:jqmData(role="footer"):visible');var g=c.getHeight()-e.outerHeight()-f.outerHeight();$wrapper.height(g);$wrapper.bind("touchmove",function(a){a.preventDefault()});setTimeout(function(){a.iScroll=new iScroll($wrapper.get(0),{desktopCompatibility:true});if(a.iScroll==b){setTimeout(function(){a.iScroll=new iScroll($wrapper.get(0),{desktopCompatibility:true})},100)}},0)};c.loadStations=function(d){if(d==b)d="lima";if(c.stations&&c.stations.length>0)return;a('#page-list div:jqmData(role="content")').html("Cargando...");a.mobile.fixedToolbars.show(true);a.getJSON("http://chartis.herokuapp.com/places/grouped.json?callback=?&zona="+d).success(function(b){c.stations=b;var d="";d+='<div data-iscroll="scroller">';d+='<ul data-role="listview">';d+="<li><h3>Estaciones</h3></li>";for(district in c.stations){d+='<li data-role="list-divider">'+district+"</li>";a.each(c.stations[district],function(a){d+='<li><a href="#page-station-details" data-district="'+district+'" data-place="'+a+'" ><h3>'+this.name+"</h3><p>"+this.address+"</p></a></li>"})}d+="</ul>";d+="</div>";a('#page-list div:jqmData(role="content")').html(d).find("ul:first").listview({create:function(){c.setScroll(a("#page-list"));setTimeout(function(){a.iScroll.refresh()},0);a.mobile.fixedToolbars.show(true)}});a.mobile.fixedToolbars.show(true);a('#page-list a[href="#page-station-details"]').each(function(b){a(this).click(function(b){var d=a(this).attr("data-district");var e=a(this).attr("data-place");c.stationSelected=c.stations[d][e]})})}).error(function(b){a.error(b);if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}})};c.loadPromos=function(d){if(d==b||d=="")d="todos";a('#page-promo div:jqmData(role="content")').html("Cargando...");a.mobile.fixedToolbars.show(true);a.getJSON("http://chartis.herokuapp.com/offers.json?callback=?"+(c.retina?"&retina=true":"")+"&type="+d).success(function(b){c.offers=b;c.offerSelected=null;var d="";d+='<div data-iscroll="scroller">';d+="<div>";d+='<ul data-role="listview" data-filter="true" data-filter-placeholder="Buscar">';a.each(c.offers,function(){d+='<li><a href="#page-promo-details"><h3>'+this.name+"</h3><p>"+this.description+"</p></a></li>"});d+="</ul>";d+="</div>";d+="</div>";a('#page-promo div:jqmData(role="content")').html(d).find("ul:first").listview({create:function(){c.setScroll(a('#page-promo div:jqmData(role="content")'));setTimeout(function(){a.iScroll.refresh()},0);a.mobile.fixedToolbars.show(true)}});a.mobile.fixedToolbars.show(true);a('#page-promo a[href="#page-promo-details"]').each(function(b){a(this).click(function(a){c.offerSelected=c.offers[b]})})}).error(function(b){a.error(b);if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}})};c.changeTitle=function(b){if(!a.exists('div:jqmData(role="header"):visible h1 .title-animate'))a('div:jqmData(role="header"):visible h1').wrapInner('<div class="title-animate"/>');a(".title-animate").animate({paddingTop:a(".title-animate").parent().height()},"fast",function(){a(".title-animate").text(b)}).animate({paddingTop:0},"fast")};c.onInitInfo=function(b){a.info("[onInitInfo]")};c.onInitServices=function(b){a.info("[onInitServices]");a("#page-services").bind("pageshow",c.onShowServices);a("#services-search").bind(clickEvent,function(b){b.preventDefault();a(".ui-page:visible .dialog-loader").show();var d=[];a("#services-grid li img").each(function(b){if(a(this).attr("src").indexOf("over")>-1){d.push(c.services[b].id)}});c.tmpPlaces=c.places;c.setPlaces({services:d,success:a.mobile.changePage,successParams:["#page-result"]})});a("#services-cancel").bind(clickEvent,function(b){b.preventDefault();a(".dialog-loader:visible").hide()});a("ul#services-grid li img").each(function(a){this.index=a+1;if(c.retina)this.src="images/service"+this.index+"@2.png"});a("ul#services-grid li img").bind(clickEvent,function(a){a.preventDefault();if(this.src.match(/over/)){this.src="images/service"+this.index+(c.retina?"@2":"")+".png"}else{this.src="images/service"+this.index+(c.retina?"@2":"")+"_over.png"}});if(c.retina){a(".info-bottom img")[0].src="images/info@2.png"}c.resultTravelMode="driving";a('#page-services input[type="radio"]').bind("change",function(b){b.preventDefault();c.resultTravelMode=a(this).val()})};c.onShowServices=function(b){var d="";d+='<div data-iscroll="scroller">';d+="<div>";d+='<ul data-role="listview">';a.each(c.services,function(){d+="<li>";d+='<img src="images/empty.png" width="62" height="63" data-place="'+this.id+'" class="icon-service-'+c.servicesIcon[this.id]+'"/>';d+='<div class="li-inner">';d+="<h3>"+this.name+"</h3>";d+="<p>"+(this.description||"")+"</p>";d+="</div>";d+="</li>"});d+="</ul>";d+="</div>";d+="</div>";a('#page-info div:jqmData(role="content")').html(d)};c.onInitMain=function(b){a.info("[onInitMain]");c.servicesList=[];c.servicesList["Combustibles Líquidos"]=1;c.servicesList["GNV"]=2;c.servicesList["GLP"]=3;c.servicesList["Listo"]=4;c.servicesList["Cajero BCP"]=5;c.servicesList["Agencia BCP"]=6;c.servicesList["SOAT Pacífico"]=7;c.servicesList["Wi-Fi"]=8;c.servicesList["Direct TV"]=9;a.getJSON("http://chartis.herokuapp.com/services.json?callback=?").success(function(b){c.services=b;c.servicesIcon=[];a.each(c.services,function(a){c.servicesIcon[this.id]=c.servicesList[this.name]})}).error(function(b){a.error(b);if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}});a('#page-main a[href="#page-services"]').bind(clickEvent,function(a){c.markerSelected=null;if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}});a("#page-main .GPS a").bind(clickEvent,function(a){a.preventDefault();c.markerSelected=null;if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}if(c.markerLocation)c.markerLocation.setMap(null);c.setLocation({success:function(){c.markerLocation=c.setMarkerCurrentPosition({type:"dot"})}})});a("#page-main").unbind("pageshow",c.onShowMain);a("#page-main").unbind("pageshow",c.onShowMainAlways);a("#page-main").bind("pageshow",c.onShowMain);a("#page-main").bind("pageshow",c.onShowMainAlways)};c.onShowMain=function(d){a.info("[onShowMain]");a("#page-main").unbind("pageshow",c.onShowMain);var e=a('div:jqmData(role="header"):visible');var f=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-e.outerHeight();a("#map").width(c.getWidth());a("#map").height(c.contentHeight);a("#map").parent().height(c.contentHeight-f.outerHeight());if(a.support.touch&&navigator.device==b){document.addEventListener("deviceready",n,false)}else{n()}};c.onShowMainAlways=function(b){a.info("[onShowMainAlways]");if(c.map){c.currentMap=c.map;c.currentMap.fixResize()}};c.onInitResult=function(b){a.info("[onInitResult]");a("#page-result").bind("pageshow",c.onShowResult);a("#page-result").bind("pageshow",c.onShowResultForService);a("#page-result .GPS a").bind(clickEvent,function(a){a.preventDefault();if(c.routeLocationMarker)c.currentMap.removeMarker(c.routeLocationMarker);c.setLocation({success:function(){c.routeLocationMarker=c.setMarkerCurrentPosition()}})})};c.getHeight=function(){return a.support.touch?screen.availHeight:a(window).height()};c.getWidth=function(){return a.support.touch?screen.availWidth:a(window).width()};c.onShowResult=function(b){a.info("[onShowResult]");a("#page-result").unbind("pageshow",c.onShowResult);var d=a('div:jqmData(role="header"):visible');var e=a('div:jqmData(role="footer"):visible');c.contentHeight=c.getHeight()-d.outerHeight();a("#map-result").width(c.getWidth());a("#map-result").height(c.contentHeight);a("#map-result").parent().height(c.contentHeight-e.outerHeight());c.mapResult=c.mapResult||new GMaps({div:"#map-result",lat:-12.090689,lng:-77.010877,zoom:15,disableDefaultUI:true,click:function(a){c.markerSelected=null;if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}}})};c.onShowResultForService=function(b){a.info("[onShowResultForService]");if(c.mapResult==null)return;a(".ui-page:visible .ui-radio label").each(function(b){if(a(this).hasClass("ui-radio-on")){a('.ui-page:visible input[type="radio"]:eq('+b+")").attr("checked",true).checkboxradio("refresh")}});if(a('.ui-page:visible input[type="radio"]:checked').length==0){a('.ui-page:visible input[type="radio"]:first').attr("checked",true).checkboxradio("refresh")}c.routeLocationMarker=null;c.mapResult.removeMarkers();c.mapResult.removeOverlays();c.mapResult.removePolylines();c.currentMap=c.mapResult;c.addPlacesInMap(c.places);var d=c.places.length;var e=[];for(i=0;i<d;i++){e.push(new google.maps.LatLng(c.places[i].lat,c.places[i].lng))}c.currentMap.fitBounds(e);c.places=c.tmpPlaces;c.currentMap.fixResize()};c.geolocate=function(a){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(b){a.success(b);if(a.always)a.always()},function(b){a.error(b);if(a.always)a.always()},{enableHighAccuracy:true})}else{if(a.not_supported)a.not_supported();if(a.always)a.always()}};c.geocode=function(a){var b=a.callback;if(a.lat&&a.lng)a["latLng"]=new google.maps.LatLng(a.lat,a.lng);delete a.lat;delete a.lng;delete a.callback;c.geocoder.geocode(a,function(a,c){b(a,c)})};c.setPlaces=function(b){a.info("[setPlaces]");c.placeNearest=null;c.places=c.places||[];a.log("Places total: "+c.places.length);if(c.places.length==0||b.services&&b.services.length>0){c.placesLoad(b)}else{if(b&&b.success){b.success.apply(window,b.successParams||[])}}};c.setMarkerCurrentPosition=function(d){a.info("[setMarkerCurrentPosition]");d=d||{};if(d.center==b)d.center=true;if(d.pinType==b)d.pinType="red";var e=d.location?d.location:c.location;var f=c.currentMap.addMarker(a.extend({click:function(a){if(a.preventDefault)a.preventDefault();if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}var b=a.marker.position.lat();var d=a.marker.position.lng();c.markerSelected=a.marker;c.currentMap.setCenter(b,d);c.setOverlayItem({right:false,clickButtonLeft:null,clickButtonRight:null})}},e));if(d.type=="dot"){f.icon=new google.maps.MarkerImage("images/map/location"+(c.retina?"@2":"")+".png",new google.maps.Size(20,21),new google.maps.Point(0,0),new google.maps.Point(10,10),new google.maps.Size(20,21));f.shape={coord:[13,0,15,1,16,2,17,3,18,4,19,5,19,6,19,7,19,8,19,9,19,10,19,11,19,12,19,13,18,14,19,15,19,16,18,17,18,18,16,19,3,19,2,18,1,17,0,16,0,15,1,14,0,13,0,12,0,11,0,10,0,9,0,8,0,7,0,6,0,5,1,4,2,3,3,2,4,1,6,0,13,0],type:"poly"}}else{f.icon=new google.maps.MarkerImage("images/map/pin-"+d.pinType+(c.retina?"@2x":"")+".png",new google.maps.Size(16,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(16,37):null);f.shadow=new google.maps.MarkerImage("images/map/pin-shadow"+(c.retina?"@2x":"")+".png",new google.maps.Size(38,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(38,37):null);f.shape={coord:[10,0,12,1,13,2,14,3,15,4,15,5,15,6,15,7,15,8,15,9,15,10,15,11,15,12,14,13,13,14,11,15,9,16,9,17,9,18,9,19,9,20,9,21,9,22,9,23,9,24,9,25,9,26,9,27,9,28,9,29,9,30,9,31,9,32,11,33,11,34,11,35,11,36,4,36,4,35,5,34,5,33,7,32,7,31,7,30,7,29,7,28,7,27,7,26,7,25,7,24,7,23,7,22,7,21,7,20,7,19,7,18,7,17,7,16,5,15,3,14,2,13,1,12,1,11,0,10,0,9,0,8,0,7,0,6,1,5,1,4,2,3,3,2,4,1,6,0,10,0],type:"poly"}}d.center&&c.currentMap.setCenter(e.lat,e.lng);return f};c.placesLoad=function(b){if(c.placesLoading)return;a.info("[placesLoad] init");c.placesLoading=true;var d={};if(b.services&&b.services.length>0){d={services_id:b.services}}a.getJSON("http://chartis.herokuapp.com/places.json?callback=?",d).success(function(d){a.info("[placesLoad] success",d.length);c.placesLoading=false;c.placeNearest=null;c.places=d;if(b&&b.success){b.success.apply(window,b.successParams||[])}}).error(function(b){a.error("[placesLoad] error\n",b);c.placesLoading=false;if(b.statusText=="timeout"){alert("Se ha superado el tiempo máximo de carga. Vuelva a intentarlo más tarde.")}})};c.addPlacesInMap=function(b){a.info("[addPlacesInMap]");a.each(b,function(){this.marker=c.currentMap.addMarker({lat:this.lat,lng:this.lng,title:this.name,address:this.address,station:this,click:function(a){if(a.preventDefault)a.preventDefault();if(c.overlayItem)c.currentMap.removeOverlay(c.overlayItem);var b=a.marker.position.lat();var d=a.marker.position.lng();c.markerSelected=a.marker;c.currentMap.setCenter(b,d);c.setOverlayItem()}});this.marker.icon=new google.maps.MarkerImage("images/map/pin-green2"+(c.retina?"@2x":"")+".png",new google.maps.Size(16,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(16,37):null);this.marker.shadow=new google.maps.MarkerImage("images/map/pin-shadow"+(c.retina?"@2x":"")+".png",new google.maps.Size(38,37),new google.maps.Point(0,0),new google.maps.Point(8,37),c.retina?new google.maps.Size(38,37):null);this.marker.shape={coord:[10,0,12,1,13,2,14,3,15,4,15,5,15,6,15,7,15,8,15,9,15,10,15,11,15,12,14,13,13,14,11,15,9,16,9,17,9,18,9,19,9,20,9,21,9,22,9,23,9,24,9,25,9,26,9,27,9,28,9,29,9,30,9,31,9,32,11,33,11,34,11,35,11,36,4,36,4,35,5,34,5,33,7,32,7,31,7,30,7,29,7,28,7,27,7,26,7,25,7,24,7,23,7,22,7,21,7,20,7,19,7,18,7,17,7,16,5,15,3,14,2,13,1,12,1,11,0,10,0,9,0,8,0,7,0,6,1,5,1,4,2,3,3,2,4,1,6,0,10,0],type:"poly"}})};c.setOverlayItem=function(b){var d=c.markerSelected;var e=d.position.lat();var f=d.position.lng();var g=(b==null||b.right)==true;b&&delete b["right"];c.overlayItem=c.currentMap.drawOverlay(a.extend({lat:e,lng:f,content:['<div class="overlay">','<div class="overlay-btn-left"></div>','<div class="overlar-text-container">','<div class="overlay-title">'+d.title+"</div>",'<div class="overlay-subtitle">'+d.address+"</div>","</div>",g?'<div class="overlay-btn-right"></div>':"","</div>"].join(""),verticalAlign:"top",horizontalAlign:"center",verticalOffset:-38,horizontalOffset:-8,layer:"floatPane",clickButtonLeft:function(b){if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}c.placeNearest=c.markerSelected.station;c.placeNearest.marker=c.markerSelected;a.mobile.changePage("#page-route")},clickButtonRight:function(b){if(c.overlayItem){c.currentMap.removeOverlay(c.overlayItem)}c.stationSelected=c.markerSelected.station;a.mobile.changePage("#page-station-details")}},b))};c.setLocation=function(b){a.info("[setLocation]");c.geolocate({success:function(d){a.info("[setLocation] success");c.location={lat:d.coords.latitude,lng:d.coords.longitude,title:"Ubicación Actual",address:""};c.geocode({lat:c.location.lat,lng:c.location.lng,callback:function(a,d){switch(d){case google.maps.GeocoderStatus.OK:c.location.address=a.length?a[0].formatted_address:"";break;default:c.location.address="...";break}if(b&&b.success){b.success.apply(window,b.successParams||[])}}})},error:function(a){alert("Geolocation failed: "+a.message);if(b&&b.error){b.error(a.message)}},not_supported:function(){alert("Your browser does not support geolocation :(");if(b&&b.error){b.error("No Soportado.")}},always:function(){}})};c.ready();return c}(jQuery)